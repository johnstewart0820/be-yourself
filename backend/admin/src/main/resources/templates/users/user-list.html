<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main-layout.html}">
<head>
<title>Home</title>

</head>
<body>
	<div layout:fragment="content">

		<div class="card shadow">
			<div class="card-header border-0">
				<form id="select_form" role="form"
					th:action="${baseURL} + '/search'" method="get">
					<div class="row mb-3">
						<div class="col-md-6">
							<th:block th:if="${writePermission}">
								<a class="btn btn-icon btn-2 btn-primary"
									th:href="${baseURL + '/create'}"> <span
									class="btn-inner--icon"> <i class="fas fa-edit"></i> <span
										th:text="#{action.create}"></span>
								</span>
								</a>
							</th:block>
						</div>
						<div class="col-md-6">
							<div class="form-group mb-0">
								<div class="input-group input-group-alternative">
									<th:block th:if="${baseURL != null && baseURL != ''}">
										<div class="input-group-prepend">
											<span class="input-group-text"> <i
												class="fas fa-search"></i>
											</span>
										</div>
										<input class="form-control" type="text" name="q"
											th:placeholder="#{search.placeholder}" th:value="${search}">
									</th:block>
								</div>
							</div>
						</div>
					</div>
					<div class="row form-search-container">
						<div class="col-md-3 text-right">

							<select id="filter_subtype" class="selectpicker show-tick"
								multiple data-actions-box="true" data-live-search="true"
								th:data-select-all-text="#{data.display.button.select.all}"
								th:data-deselect-all-text="#{data.display.button.deselect.all}"
								th:title="#{|${baseMessageKey}.option.filter.subtype.title|}"
								th:data-none-selected-text="#{|${baseMessageKey}.option.filter.subtype.title|}"
								data-selected-text-format="count > 2"
								th:data-count-selected-text="#{|${baseMessageKey}.option.filter.subtype.many|}">
								<option th:each="subtype: ${subtypes}" th:value="${subtype.id}"
									th:text="${subtype.name}"
									th:selected="${#arrays.contains(filteredSubscriptionTypesIds, subtype.id)}"></option>
							</select>

						</div>
						<div class="col-md-3 text-right">
							<select id="filter_role" name="filter_role"
								class="selectpicker show-tick">
								<option value="">FILTER BY ROLE</option>
								<option th:each="userType : ${userTypes}" th:value="${userType}"
									th:text="#{'user.type.' + ${userType}}">></option>
							</select>

						</div>
						<div class="col-md-3 text-right">
							<select id="filter_status" name="filter_status"
								class="selectpicker show-tick">
								<option value="-2">FILTER BY STATUS</option>
								<option th:each="userStatus : ${userStatuses}"
									th:value="${userStatus}"
									th:text="#{'user.status.' + ${userStatus}}">></option>
							</select>

						</div>
						<div class="col-md-3 text-right">
							<select id="display-page-option" class="selectpicker show-tick"
								th:data-none-selected-text="#{data.display.page.option.title}">
								<option th:each="pageSize: ${supportPageSizes}"
									th:value="${pageSize}"
									th:text="#{data.display.page.option.item(${pageSize}, ${pageSizeName})}"
									th:selected="${size != null && size == pageSize}"></option>
								<option value="-1"
									th:text="#{data.display.page.option.all(${pageSizeName})}"
									th:selected="${size == null || size <= 0}"></option>
							</select>
						</div>
					</div>
					<input type="submit" style="display: none" />

				</form>
				<div class="row  form-search-container">
					<div class="col">
						<a href="#select_users" class="btn btn-sm btn-primary">Select
							/ Deselect all</a> <a href="#" class="btn btn-sm btn-primary"
							onclick="document.getElementById('select_user_form').submit();">Export
							CSV</a> <a th:href="${baseURL + '/upload_csv_form'}"
							class="btn btn-sm btn-primary" th:if="${writePermission}">Import
							CSV</a> <a th:href="${baseURL + '/resetpwdbyemail'}"
							class="btn btn-sm btn-primary" th:if="${writePermission}">Reset
							password by email</a>
					</div>
				</div>
			</div>
			<!-- Table -->
			<div class="table-responsive">
				<form id="select_user_form" th:action="${baseURL + '/exportcsv'}"
					method="post">
					<table class="table align-items-center table-flush" id="user_table">
						<thead class="thead-light">
							<tr>
								<th scope="col"></th>
								<th scope="col">Email</th>
								<th scope="col">FullName</th>
								<th scope="col">Status</th>
								<th scope="col">Subscription Type</th>
								<th scope="col">Role</th>
								<th scope="col" th:if="${writePermission}"></th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="item : ${result.items}">
								<td><input type="checkbox" name="selected_id"
									id="selected_id" th:value="${item.id}"></input></td>
								<td><span th:text="${item.email}"> Email </span></td>
								<td><span th:if="${item != null}"
									th:utext="${item.fullName}"></span></td>
								<td><span th:if="${item != null}"
									th:utext="#{'user.status.' + ${item.status}}"></span></td>

								<td><span
									th:if="${item != null && item.subscription != null && 
												item.subscription.subtype != null}"
									th:utext="${item.subscription.subtype.name}"></span></td>
								<td><span th:if="${item != null}"
									th:utext="#{'user.type.' + ${item.userType}}"></span></td>

								<td class="text-right" th:if="${writePermission}"><a
									class="btn btn-icon btn-2 btn-primary"
									th:href="${baseURL + '/edit/' + item.id}"
									th:title="#{action.edit.title}"> <span
										class="btn-inner--icon"> <i class="fas fa-edit"></i>
									</span>
								</a>

									<button class="btn btn-icon btn-2 btn-danger" type="button"
										th:title="#{action.delete.title}"
										th:onclick="confirmDelete([[${item.id}]])">
										<span class="btn-inner--icon"> <i class="fas fa-times"></i>
										</span>
									</button></td>
							</tr>
						</tbody>
					</table>
				</form>

			</div>
			<!-- End table -->

			<div class="card-footer py-4"
				th:insert="fragments/data-list-pagination :: pagination"></div>
		</div>

		<div class="modal fade" id="confirm-delete-modal" tabindex="-1"
			role="dialog" aria-labelledby="deleteConfirmModal" aria-hidden="true"
			data-backdrop="false">
			<div class="modal-dialog modal-dialog-centered modal-7"
				role="document">
				<div class="modal-content">
					<form id="confirm-delete-form" action="javascript:;" method="POST">
						<div class="modal-header modal-header-danger">
							<h3 class="modal-title" id="confirm-delete-modal-title"
								th:utext="#{modal.confirm.delete.title}"></h3>
							<button type="button" class="close" data-dismiss="modal"
								aria-label="Close">
								<span aria-hidden="true">Ã—</span>
							</button>
						</div>
						<div class="modal-body">
							<p
								th:utext="#{modal.confirm.delete.message(#{${baseMessageKey} + '.name'})}"></p>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-danger"
								th:utext="#{modal.button.yes}">Yes</button>
							<button type="button" class="btn btn-secondary ml-auto"
								data-dismiss="modal" th:utext="#{modal.button.no}">No</button>
						</div>
					</form>
				</div>
			</div>
		</div>

	</div>


	<section layout:fragment="scripts">
		<script>
			var filter_role = "";
			var filter_status = -2;
			var filter_subtype = -2;
			var search_box = "";
		</script>

		<script th:if="${filterSubtype != null}">
			filter_subtype = "[[${filterSubtype}]]";
		</script>

		<script th:if="${filterRole != null}">
			filter_role = "[[${filterRole}]]";
		</script>

		<script th:if="${filterStatus != null}">
			filter_status = "[[${filterStatus}]]";
		</script>
		<script>
			var select_all = false;
			function confirmDelete(id) {
				var url = '[[${baseURL}]]/delete/' + id;

				$('#confirm-delete-form').attr('action', url);
				showModal('confirm-delete-modal');
			}

			$(document)
					.ready(
							function() {
								$('#user_table').DataTable({
									"sDom" : 't'
								});

								$('#filter_role').val(filter_role);
								$("#filter_status").val(filter_status);
								$("#search_box").val("[[${search_box}]]");

								$("select#filter_subtype")
										.change(
												function() {
													$("#filter_role")
															.val(
																	$(
																			"#filter_role option:first")
																			.val());
													$("#filter_status")
															.val(
																	$(
																			"#filter_status option:first")
																			.val());

													const selectedStatus = $(
															'#filter_status')
															.val();
													const selectedRole = $(
															'#filter_role')
															.val();
													const selectedSubtype = $(
															'#filter_subtype')
															.val();
													encodedSelectedSubtypeIds = encodeURIComponent(selectedSubtype
															.join(','));

													window.location = '[[${baseURL}]]/search?action=update-filter&filterRole='
															+ selectedRole
															+ '&filterStatus='
															+ selectedStatus
															+ '&filterSubscriptionTypesIds='
															+ encodedSelectedSubtypeIds;
												});

								$("select#filter_status")
										.change(
												function() {
													$("#filter_role")
															.val(
																	$(
																			"#filter_role option:first")
																			.val());
													$('#filter_subtype')
															.selectpicker(
																	'val', '');

													const selectedStatus = $(
															'#filter_status')
															.val();
													const selectedRole = $(
															'#filter_role')
															.val();
													const selectedSubtype = $(
															'#filter_subtype')
															.val();
													encodedSelectedSubtypeIds = encodeURIComponent(selectedSubtype
															.join(','));

													window.location = '[[${baseURL}]]/search?action=update-filter&filterRole='
															+ selectedRole
															+ '&filterStatus='
															+ selectedStatus
															+ '&filterSubscriptionTypesIds='
															+ encodedSelectedSubtypeIds;
												});

								$("select#filter_role")
										.change(
												function() {
													$("#filter_status")
															.val(
																	$(
																			"#filter_status option:first")
																			.val());
													$('#filter_subtype')
															.selectpicker(
																	'val', '');

													const selectedRole = $(
															'#filter_role')
															.val();
													const selectedStatus = $(
															'#filter_status')
															.val()
													const selectedSubtype = $(
															'#filter_subtype')
															.val();
													encodedSelectedSubtypeIds = encodeURIComponent(selectedSubtype
															.join(','));

													window.location = '[[${baseURL}]]/search?action=update-filter&filterRole='
															+ selectedRole
															+ '&filterStatus='
															+ selectedStatus
															+ '&filterSubscriptionTypesIds='
															+ encodedSelectedSubtypeIds;

												});

								$('a[href="#select_users"]').click(
										function() {
											if (select_all == false) {
												$("[name='selected_id']").prop(
														'checked', true);
												select_all = true;
											} else {
												$("[name='selected_id']").prop(
														'checked', false);
												select_all = false;
											}
										});

								$('#display-page-option')
										.on(
												'changed.bs.select',
												function(e, clickedIndex,
														isSelected,
														previousValue) {
													const selectedPageSize = $(
															'#display-page-option')
															.val();
													window.location = '[[${baseURL}]]/search?action=update-filter&page=1&size='
															+ selectedPageSize;
												});
							});
		</script>

	</section>

</body>
</html>